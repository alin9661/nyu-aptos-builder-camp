version: '3.9'

# Production Docker Compose configuration
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up

services:
  # PostgreSQL Database (production overrides)
  postgres:
    restart: always
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME:-nyu_aptos_prod}
    # In production, consider using managed database service
    # Comment out to use external database
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
      # Backup location
      - ./backups:/backups
    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    command: >
      postgres
      -c shared_buffers=256MB
      -c max_connections=200
      -c effective_cache_size=1GB
      -c maintenance_work_mem=128MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=2MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB

  # Backend API Service (production overrides)
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        - NODE_ENV=production
    container_name: nyu-aptos-backend-prod
    restart: always
    environment:
      NODE_ENV: production
      PORT: ${PORT:-3001}
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-nyu_aptos_prod}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_POOL_SIZE: ${DB_POOL_SIZE:-20}
      APTOS_NETWORK: ${APTOS_NETWORK:-mainnet}
      APTOS_NODE_URL: ${APTOS_NODE_URL}
      APTOS_INDEXER_URL: ${APTOS_INDEXER_URL}
      MODULE_ADDRESS: ${MODULE_ADDRESS}
      ADVISOR_ADDRESS: ${ADVISOR_ADDRESS}
      PRESIDENT_ADDRESS: ${PRESIDENT_ADDRESS}
      VICE_ADDRESS: ${VICE_ADDRESS}
      COIN_TYPE: ${COIN_TYPE}
      CORS_ORIGIN: ${CORS_ORIGIN}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      API_KEY: ${API_KEY}
      JWT_SECRET: ${JWT_SECRET}
      SENTRY_DSN: ${SENTRY_DSN}
      # IPFS configuration (use external service in production)
      IPFS_HOST: ${IPFS_HOST:-ipfs.infura.io}
      IPFS_PORT: ${IPFS_PORT:-5001}
      IPFS_PROTOCOL: ${IPFS_PROTOCOL:-https}
      IPFS_PROJECT_ID: ${IPFS_PROJECT_ID}
      IPFS_PROJECT_SECRET: ${IPFS_PROJECT_SECRET}
      # Redis configuration
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
    # Only expose to localhost or use reverse proxy
    ports:
      - "127.0.0.1:3001:3001"
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      # Production: Run multiple replicas
      replicas: 2
    volumes:
      # Mount logs for persistence
      - ./logs:/app/logs
    # Stricter healthcheck for production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Security options
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /app/logs

  # Redis (production configuration)
  redis:
    restart: always
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_prod_data:/data
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    profiles: []  # Enable by default

  # Production: Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: nyu-aptos-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - backend
    networks:
      - aptos-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
    profiles:
      - with-nginx

  # Production: Monitoring with Prometheus (optional)
  prometheus:
    image: prom/prometheus:latest
    container_name: nyu-aptos-prometheus
    restart: always
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
    ports:
      - "127.0.0.1:9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - aptos-network
    profiles:
      - with-monitoring

  # Production: Grafana for visualization (optional)
  grafana:
    image: grafana/grafana:latest
    container_name: nyu-aptos-grafana
    restart: always
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
      GF_USERS_ALLOW_SIGN_UP: 'false'
    ports:
      - "127.0.0.1:3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      - prometheus
    networks:
      - aptos-network
    profiles:
      - with-monitoring

volumes:
  postgres_prod_data:
    driver: local
  redis_prod_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
