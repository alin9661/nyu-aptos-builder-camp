apiVersion: v1
kind: ConfigMap
metadata:
  name: nyu-aptos-config
  namespace: nyu-aptos
  labels:
    app: nyu-aptos-backend
data:
  # Server Configuration
  node_env: "production"
  port: "3001"
  log_level: "info"
  cors_origin: "https://nyuaptos.example.com"

  # Database Configuration
  db_host: "postgres-service.nyu-aptos.svc.cluster.local"
  db_port: "5432"
  db_name: "nyu_aptos_prod"
  db_pool_size: "20"

  # Aptos Network Configuration
  aptos_network: "mainnet"
  aptos_node_url: "https://fullnode.mainnet.aptoslabs.com/v1"
  aptos_indexer_url: "https://indexer.mainnet.aptoslabs.com/v1/graphql"

  # Module Addresses (update with actual deployed addresses)
  module_address: "0x1"
  advisor_address: "0x2"
  president_address: "0x3"
  vice_address: "0x4"

  # Coin Type
  coin_type: "0x1::aptos_coin::AptosCoin"

  # IPFS Configuration (production)
  ipfs_host: "ipfs.infura.io"
  ipfs_port: "5001"
  ipfs_protocol: "https"
  ipfs_gateway: "https://ipfs.io"

  # Indexer Configuration
  indexer_poll_interval: "5000"
  indexer_batch_size: "100"

  # Redis Configuration (if using)
  redis_host: "redis-service.nyu-aptos.svc.cluster.local"
  redis_port: "6379"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nyu-aptos-postgres-init
  namespace: nyu-aptos
  labels:
    app: postgres
data:
  init.sql: |
    -- Initialize NYU Aptos Database Schema

    -- Create extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    -- Create tables for proposals
    CREATE TABLE IF NOT EXISTS proposals (
      id BIGSERIAL PRIMARY KEY,
      proposal_id BIGINT UNIQUE NOT NULL,
      proposer VARCHAR(66) NOT NULL,
      title VARCHAR(255) NOT NULL,
      description TEXT,
      ipfs_hash VARCHAR(100),
      proposal_type VARCHAR(50) NOT NULL,
      voting_start_time BIGINT NOT NULL,
      voting_end_time BIGINT NOT NULL,
      quorum_required BIGINT NOT NULL,
      votes_for BIGINT DEFAULT 0,
      votes_against BIGINT DEFAULT 0,
      votes_abstain BIGINT DEFAULT 0,
      status VARCHAR(50) DEFAULT 'active',
      executed BOOLEAN DEFAULT FALSE,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );

    -- Create indexes for proposals
    CREATE INDEX IF NOT EXISTS idx_proposals_status ON proposals(status);
    CREATE INDEX IF NOT EXISTS idx_proposals_proposer ON proposals(proposer);
    CREATE INDEX IF NOT EXISTS idx_proposals_type ON proposals(proposal_type);
    CREATE INDEX IF NOT EXISTS idx_proposals_voting_end ON proposals(voting_end_time);

    -- Create votes table
    CREATE TABLE IF NOT EXISTS votes (
      id BIGSERIAL PRIMARY KEY,
      proposal_id BIGINT NOT NULL,
      voter VARCHAR(66) NOT NULL,
      vote_type VARCHAR(20) NOT NULL,
      voting_power BIGINT NOT NULL,
      voted_at BIGINT NOT NULL,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
      UNIQUE(proposal_id, voter),
      FOREIGN KEY (proposal_id) REFERENCES proposals(proposal_id) ON DELETE CASCADE
    );

    -- Create indexes for votes
    CREATE INDEX IF NOT EXISTS idx_votes_proposal ON votes(proposal_id);
    CREATE INDEX IF NOT EXISTS idx_votes_voter ON votes(voter);

    -- Create treasury transactions table
    CREATE TABLE IF NOT EXISTS treasury_transactions (
      id BIGSERIAL PRIMARY KEY,
      version BIGINT UNIQUE NOT NULL,
      hash VARCHAR(66) NOT NULL,
      sender VARCHAR(66) NOT NULL,
      receiver VARCHAR(66),
      amount BIGINT NOT NULL,
      coin_type VARCHAR(255) NOT NULL,
      transaction_type VARCHAR(50) NOT NULL,
      timestamp BIGINT NOT NULL,
      success BOOLEAN NOT NULL,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );

    -- Create indexes for treasury transactions
    CREATE INDEX IF NOT EXISTS idx_treasury_tx_sender ON treasury_transactions(sender);
    CREATE INDEX IF NOT EXISTS idx_treasury_tx_receiver ON treasury_transactions(receiver);
    CREATE INDEX IF NOT EXISTS idx_treasury_tx_type ON treasury_transactions(transaction_type);
    CREATE INDEX IF NOT EXISTS idx_treasury_tx_timestamp ON treasury_transactions(timestamp DESC);

    -- Create reimbursement requests table
    CREATE TABLE IF NOT EXISTS reimbursement_requests (
      id BIGSERIAL PRIMARY KEY,
      request_id BIGINT UNIQUE NOT NULL,
      requester VARCHAR(66) NOT NULL,
      amount BIGINT NOT NULL,
      reason TEXT,
      ipfs_hash VARCHAR(100),
      status VARCHAR(50) DEFAULT 'pending',
      approved_by VARCHAR(66),
      approved_at BIGINT,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );

    -- Create indexes for reimbursements
    CREATE INDEX IF NOT EXISTS idx_reimbursement_status ON reimbursement_requests(status);
    CREATE INDEX IF NOT EXISTS idx_reimbursement_requester ON reimbursement_requests(requester);

    -- Create governance elections table
    CREATE TABLE IF NOT EXISTS elections (
      id BIGSERIAL PRIMARY KEY,
      election_id BIGINT NOT NULL,
      role VARCHAR(50) NOT NULL,
      start_time BIGINT NOT NULL,
      end_time BIGINT NOT NULL,
      status VARCHAR(50) DEFAULT 'active',
      winner VARCHAR(66),
      created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
      UNIQUE(election_id, role)
    );

    -- Create indexes for elections
    CREATE INDEX IF NOT EXISTS idx_elections_status ON elections(status);
    CREATE INDEX IF NOT EXISTS idx_elections_role ON elections(role);

    -- Create updated_at trigger function
    CREATE OR REPLACE FUNCTION update_updated_at_column()
    RETURNS TRIGGER AS $$
    BEGIN
      NEW.updated_at = CURRENT_TIMESTAMP;
      RETURN NEW;
    END;
    $$ language 'plpgsql';

    -- Add triggers for updated_at
    DROP TRIGGER IF EXISTS update_proposals_updated_at ON proposals;
    CREATE TRIGGER update_proposals_updated_at
      BEFORE UPDATE ON proposals
      FOR EACH ROW
      EXECUTE FUNCTION update_updated_at_column();

    DROP TRIGGER IF EXISTS update_reimbursements_updated_at ON reimbursement_requests;
    CREATE TRIGGER update_reimbursements_updated_at
      BEFORE UPDATE ON reimbursement_requests
      FOR EACH ROW
      EXECUTE FUNCTION update_updated_at_column();
